@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@model library_management_system.Models.Loan

@{
	ViewData["lang"] = System.Globalization.CultureInfo.CurrentCulture.Name;
	ViewData["Title"] = Localizer["Choose Items from Loan"];
	ViewData["ActiveNav"] = "Loans";
}

<form asp-controller="Loans" asp-action="DeleteItems" method="post">
	<input type="hidden" name="LoanId" value="@Model.ID" />

	<div class="mb-3 row align-items-center">
		<h1 class="display-4 col-12 col-md-8">@Localizer["Loan Details"]</h1>
		<div class="col-12 col-md-4 text-md-end">
			<button type="submit" class="btn btn-outline-danger"><i class="bi bi-trash me-2" aria-hidden="true"></i>
				@Localizer["Delete Selected Items"]</button>
		</div>
	</div>

	<div class="row mb-5">
		<p>@Localizer["Consider marking the loan as returned instead of deleting the items. It will keep the history intact."]</p>
	</div>

	<ul class="nav nav-tabs mb-3" id="loanItemsTabs" role="tablist">
		<li class="nav-item" role="presentation">
			<button class="fs-5 nav-link active" id="books-tab" data-bs-toggle="tab" data-bs-target="#books-tab-pane"
				type="button" role="tab" aria-controls="books-tab-pane" aria-selected="true">
				@Localizer["Books"]
				(<span class="selected-count" data-group="LoanBookIds">0</span>@if (Model.LoanBooks.Count > 0)
				{<span>/@Model.LoanBooks.Count</span>})
			</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="fs-5 nav-link" id="movies-tab" data-bs-toggle="tab" data-bs-target="#movies-tab-pane"
				type="button" role="tab" aria-controls="movies-tab-pane" aria-selected="false">
				@Localizer["Movies"]
				(<span class="selected-count" data-group="LoanMovieIds">0</span>@if (Model.LoanMovies.Count > 0)
				{<span>/@Model.LoanMovies.Count</span>})
			</button>
		</li>
		<li class="nav-item" role="presentation">
			<button class="fs-5 nav-link" id="music-discs-tab" data-bs-toggle="tab"
				data-bs-target="#music-discs-tab-pane" type="button" role="tab" aria-controls="music-discs-tab-pane"
				aria-selected="false">
				@Localizer["Music Discs"]
				(<span class="selected-count" data-group="LoanMusicDiscIds">0</span>@if (Model.LoanMusicDiscs.Count > 0)
				{<span>/@Model.LoanMusicDiscs.Count</span>})
			</button>
		</li>
	</ul>

	<div class="tab-content mb-5" id="loanItemsTabsContent">
		<div class="tab-pane fade show active" id="books-tab-pane" role="tabpanel" aria-labelledby="books-tab"
			tabindex="0">
			@if (Model.LoanBooks.Count == 0)
			{
				<p>@Localizer["No books have been loaned."]</p>
			}
			else
			{
				<div class="table-responsive">
					<table class="table table-hover">
						<thead>
							<tr>
								<th></th>
								<th scope="col">@Html.DisplayNameFor(model => model.LoanBooks.First().Book!.Title)</th>
								<th scope="col">@Html.DisplayNameFor(model => model.LoanBooks.First().Book!.Author)</th>
								<th scope="col">@Html.DisplayNameFor(model => model.LoanBooks.First().Book!.ISBN_10)</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var loanBook in Model.LoanBooks.OrderBy(lb => lb.Book!.Title))
							{
								<tr>
									<td><input type="checkbox" name="LoanBookIds" value="@loanBook.ID" class="item-checkbox" />
									</td>
									<td>@Html.DisplayFor(model => loanBook.Book!.Title)</td>
									<td>@Html.DisplayFor(model => loanBook.Book!.Author)</td>
									<td>@Html.DisplayFor(model => loanBook.Book!.ISBN_10)</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			}
		</div>

		<div class="tab-pane fade" id="movies-tab-pane" role="tabpanel" aria-labelledby="movies-tab" tabindex="0">
			@if (Model.LoanMovies.Count == 0)
			{
				<p>@Localizer["No movies have been loaned."]</p>
			}
			else
			{
				<div class="table-responsive">
					<table class="table table-hover">
						<thead>
							<tr>
								<th></th>
								<th scope="col">@Localizer["Title"]</th>
								<th scope="col">@Html.DisplayNameFor(model => model.LoanMovies.First().Movie!.Director)</th>
								<th scope="col">@Html.DisplayNameFor(model => model.LoanMovies.First().Movie!.ReleaseYear)
								</th>
							</tr>
						</thead>
						<tbody>
							@foreach (var loanMovie in Model.LoanMovies.OrderBy(lm => lm.Movie!.Title))
							{
								<tr>
									<td><input type="checkbox" name="LoanMovieIds" value="@loanMovie.ID"
											class="item-checkbox" /></td>
									<td>@("fr".Equals(ViewData["lang"]) ? loanMovie.Movie!.TitleFr ?? loanMovie.Movie!.Title :
																		loanMovie.Movie!.Title)</td>
									<td>@Html.DisplayFor(model => loanMovie.Movie!.Director)</td>
									<td>@Html.DisplayFor(model => loanMovie.Movie!.ReleaseYear)</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			}
		</div>

		<div class="tab-pane fade" id="music-discs-tab-pane" role="tabpanel" aria-labelledby="music-discs-tab"
			tabindex="0">
			@if (Model.LoanMusicDiscs.Count == 0)
			{
				<p>@Localizer["No music discs have been loaned."]</p>
			}
			else
			{
				<div class="table-responsive">
					<table class="table table-hover">
						<thead>
							<tr>
								<th></th>
								<th scope="col">@Html.DisplayNameFor(model => model.LoanMusicDiscs.First().MusicDisc!.Title)
								</th>
								<th scope="col">@Html.DisplayNameFor(model =>
																	model.LoanMusicDiscs.First().MusicDisc!.Artist)</th>
							<th scope="col">@Html.DisplayNameFor(model =>
																model.LoanMusicDiscs.First().MusicDisc!.Version)</th>
							<th scope="col">@Html.DisplayNameFor(model => model.LoanMusicDiscs.First().MusicDisc!.EAN)
							</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var loanMusicDisc in Model.LoanMusicDiscs.OrderBy(lmd => lmd.MusicDisc!.Title))
							{
								<tr>
									<td><input type="checkbox" name="LoanMusicDiscIds" value="@loanMusicDisc.ID"
											class="item-checkbox" /></td>
									<td>@Html.DisplayFor(model => loanMusicDisc.MusicDisc!.Title)</td>
									<td>@Html.DisplayFor(model => loanMusicDisc.MusicDisc!.Artist)</td>
									<td>@Html.DisplayFor(model => loanMusicDisc.MusicDisc!.Version)</td>
									<td>@Html.DisplayFor(model => loanMusicDisc.MusicDisc!.EAN)</td>
								</tr>
							}
						</tbody>
					</table>
				</div>
			}
		</div>
	</div>

</form>

@section Scripts {
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			function updateSelectedCount(groupName) {
				const checkboxes = document.querySelectorAll(`input[name="${groupName}"]`);
				const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
				const countSpan = document.querySelector(`.selected-count[data-group="${groupName}"]`);
				if (countSpan) {
					countSpan.textContent = `${checkedCount}`;
				}
			}

			document.querySelectorAll('.item-checkbox').forEach(checkbox => {
				checkbox.addEventListener('change', function () {
					updateSelectedCount(this.name);
				});
			});

			updateSelectedCount('LoanBookIds');
			updateSelectedCount('LoanMovieIds');
			updateSelectedCount('LoanMusicDiscIds');
		});
	</script>
}
